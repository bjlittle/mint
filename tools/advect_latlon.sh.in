#!/bin/bash

export DYLD_LIBRARY_PATH=$VTK_DIR/../..
export LD_LIBRARY_PATH=$VTK_DIR/../..

NX=20
NY=10
STREAM_FUNC="10*(sin((pi*(x-30.-2*y))/360.)+sin((pi*(x-30.+2*y))/360.))/2."
U="10*((pi*cos((pi*(x-30.-2*y))/360.))/180.-(pi*cos((pi*(x-30.+2*y))/360.))/180.)/2."
V="10*((pi*cos((pi*(x-30.-2*y))/360.))/360.+(pi*cos((pi*(x-30.+2*y))/360.))/360.)/2."
NSTEPS=10

# generate grid.nc:physics with edge_integrated_velocity 
python @CMAKE_SOURCE_DIR@/tools/generate_latlon_ugrid.py -nx $NX -ny $NY -s $STREAM_FUNC -o grid.nc:physics

# save the grid as a VTK file
python @CMAKE_SOURCE_DIR@/tools/ugrid_reader.py -i grid.nc:physics -V grid.vtk

# push the grid upstream grid
python @CMAKE_SOURCE_DIR@/tools/generate_upstream_grid.py -u $U -v $V -g grid.nc:physics -o upstream.nc

cp grid.nc data.nc

for step in $(seq -f "%05g" 1 $NSTEPS); do
	echo "step $step"
    # regrid from current to upstream
    @CMAKE_BINARY_DIR@/tools/regrid_edges -s grid.nc:physics -S 0 \
                                          -d "upstream.nc:physics" -D 0 \
                                          -v "edge_integrated_velocity@data.nc:physics" \
                                          -o upstream_${step}.vtk -O data.nc:physics
    python @CMAKE_SOURCE_DIR@/tools/cellByCell2Edges.py -i upstream_${step}.vtk -v edge_integrated_velocity -o edge_upstream_${step}.vtk
    cp data.nc data_${step}.nc
done

