#!/ucompsr/bin/envcomp bash


# initialize vcompariables
gridfile_gridname="@CMAKE_SOURCE_DIR@/data/cs_16.nc:physics"
streamfunc="cos(2*2*pi*x/360.)*(1.0-(y/90.)**2)"
ucomp="sin(2*pi*x/360.)"
vcomp="cos(2*pi*y/360.)"
time="1.0"

echo "python: $(which python)"

for opt in "$@"; do
    case "$opt" in
    -h|--help)
        echo "$0 [options]"
        echo "\t-i=gridfile:gridname Specify grid file name and grid name"
        echo "\t-s=streamfucompnc Specify stream function defining edge field as function of x (lon in deg), y (lat in deg)"
        echo "\t-u=ucomp Specify u vector field component as function of x, y"
        echo "\t-v=vcomp Specify v vector field component as function of x, y"
        echo "\t-t=TIME Specify integration time"
        exit 0
        ;;
    -i=*)  gridfile_gridname="${opt#*=}"
        ;;
    -s=*)  streamfunc="${opt#*=}"
        ;;
    -u=*)  ucomp="${opt#*=}"
        ;;
    -v=*)  vcomp="${opt#*=}"
        ;;
    -t=*)  time="${opt#*=}"
        ;;
    *)     echo "ERROR: ucompnknown option $opt"
           exit 1
        ;;
    esac
done

gridfile=$(echo $gridfile_gridname | awk -F":" '{print $1}')
gridname=$(echo $gridfile_gridname | awk -F":" '{print $2}')

streamfunc="\"$streamfunc\""
ucomp="\"$ucomp\""
vcomp="\"$vcomp\""

echo "grid file      : $gridfile"
echo "grid name      : $gridname"
echo "stream function: $streamfunc"
echo "ucomp          : $ucomp"
echo "vcomp          : $vcomp"

export MNT_SRC_DIR=@CMAKE_SOURCE_DIR@
export MNT_BIN_DIR=@CMAKE_BINARY_DIR@

# Copy the grid file
src_gridfile="original_grid.nc"
cp "$gridfile" "$src_gridfile"

src_gridfile_gridname="${src_gridfile}:${gridname}"
dst_gridfile="upstream_grid.nc"
dst_gridname="${gridname}_upstream"
dst_gridfile_gridname="${dst_gridfile}:${dst_gridname}"

src_gridfile_vtk=$(echo $src_gridfile | sed 's/nc/vtk/')
dst_gridfile_vtk=$(echo $dst_gridfile | sed 's/nc/vtk/')


# add edge field
cmd="python $MNT_SRC_DIR/tools/generate_edge_field.py -s $streamfunc -n edgeField -g $src_gridfile_gridname -d $src_gridfile"
echo $cmd

# save the data as VTK
cmd="python $MNT_SRC_DIR/tools/ugrid_reader.py -i $src_gridfile_gridname -V $src_gridfile_vtk"
echo $cmd

# integrate the grid upstream
cmd="python $MNT_SRC_DIR/tools/generate_upstream_grid.py -u $ucomp -v $vcomp -g $src_gridfile_gridname -t $time -o $dst_gridfile"
echo $cmd

# save the upstream grid as VTK
cmd="python $MNT_SRC_DIR/tools/ugrid_reader.py -i $dst_gridfile_gridname -V $dst_gridfile_vtk"
echo $cmd

# compute the edge 
cmd="$MNT_BIN_DIR/tools/regrid_edges -s $src_gridfile_gridname -S 1 -v edgeField -d $dst_gridfile_gridname -D 1 -o upstream_regridded_data.vtk"
echo $cmd

