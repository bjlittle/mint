program test

    use mnt_ncfieldread_capi_mod
    use, intrinsic :: iso_c_binding, only: c_ptr, c_size_t, c_int

    implicit none

    include 'netcdf.inc'

    integer :: src_ncid, src_varid, src_ndims, i, rc
    integer(c_size_t), allocatable :: src_dims(:)
    character(len=512) :: src_ugrid_filename, src_field_name
    type(c_ptr)        :: ncreader_h

    src_ugrid_filename = '${CMAKE_SOURCE_DIR}/data/vel_cs_16.nc:physics'
    src_field_name = 'line_integrated_velocity'

    i = scan( src_ugrid_filename, ':' ) ! grab the filename, drop the mesh name
    rc = nf_open(src_ugrid_filename(1:i - 1), NF_NOWRITE, src_ncid)
    if (rc /= NF_NOERR) print *, 'ERROR'

    rc = nf_inq_varid(src_ncid, trim(src_field_name), src_varid)
    if (rc /= NF_NOERR) print *, 'ERROR'

    rc = mnt_ncfieldread_new(ncreader_h, src_ncid, src_varid)
    if (rc /= NF_NOERR) print *, 'ERROR'

    rc = mnt_ncfieldread_del(ncreader_h)
    if (rc /= NF_NOERR) print *, 'ERROR'

    rc = nf_close(src_ncid)
    if (rc /= NF_NOERR) print *, 'ERROR'

end program test
